<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cuestionario ‚Äì Orientaci√≥n FP (CV)</title>

  <style>
    :root{
      --bg0:#eaf4ff;
      --bg1:#f7fbff;

      --card: rgba(255,255,255,.86);
      --card2:#ffffff;

      --text:#0b2540;
      --muted:#4a6b86;

      --line: rgba(180, 218, 255, .70);

      --primary:#2f6fed;
      --primary2:#1f6ae0;
      --accent:#7c3aed;

      --radius:22px;
      --radius2:28px;

      --shadow: 0 18px 60px rgba(15, 60, 110, 0.16);
      --shadow2: 0 10px 26px rgba(15, 60, 110, 0.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% 0%, #d6ecff 0%, transparent 60%),
        radial-gradient(1000px 600px at 92% 10%, #dff3ff 0%, transparent 55%),
        radial-gradient(900px 600px at 50% 100%, #e9f6ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{
      max-width:1040px;
      margin:auto;
      padding: 26px 18px 40px;
    }

    /* topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .backlink{
      display:inline-flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      text-decoration:none;
      font-weight:950;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(180,218,255,.55);
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      transition: filter .15s ease, transform .05s ease;
    }
    .backlink:hover{filter:brightness(1.03)}
    .backlink:active{transform:scale(.99)}
    .small{
      color:var(--primary2);
      font-weight:950;
      font-size:13px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(180,218,255,.65);
      background: rgba(237,246,255,.85);
      user-select:none;
    }

    /* progress */
    .progressWrap{
      margin:10px 0 18px;
      border-radius: var(--radius2);
      border: 1px solid rgba(180,218,255,.65);
      background: rgba(255,255,255,.55);
      padding: 14px 14px 12px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .progressLine{
      height:10px;
      border-radius:999px;
      background:rgba(11,37,64,.10);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--primary),var(--accent));
      border-radius:999px;
      transition:width .25s ease;
    }
    .progressMeta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:8px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      gap:10px;
      flex-wrap:wrap;
    }

    /* cards */
    .card{
      border-radius: var(--radius2);
      border: 1px solid rgba(180,218,255,.65);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.72));
      box-shadow: var(--shadow);
      padding: 22px;
      margin-bottom:18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 320px at 12% 10%, rgba(47,111,237,.16), transparent 60%),
        radial-gradient(520px 320px at 88% 22%, rgba(124,58,237,.12), transparent 60%),
        radial-gradient(520px 380px at 60% 95%, rgba(31,106,224,.10), transparent 62%);
      pointer-events:none;
    }
    .card > *{position:relative}

    /* hero */
    .hero{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .icon{
      width:46px;
      height:46px;
      border-radius:16px;
      background: linear-gradient(135deg,var(--accent),var(--primary));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:950;
      flex:0 0 auto;
      box-shadow: 0 12px 22px rgba(47,111,237,.18);
    }
    h1{
      margin:0 0 4px;
      font-size: 26px;
      color: var(--primary2);
      letter-spacing: -0.4px;
    }
    .desc{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-weight:650;
      font-size:14px;
      max-width: 75ch;
    }

    /* question blocks */
    .qblock{
      border: 1px solid rgba(180,218,255,.70);
      background: rgba(246, 251, 255, .70);
      border-radius: 18px;
      overflow:hidden;
      margin-top: 16px;
      box-shadow: 0 10px 22px rgba(15, 60, 110, 0.06);
      animation: fadeUp .18s ease both;
    }
    @keyframes fadeUp{
      from{opacity:0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }

    .qhead{
      display:flex;
      gap:12px;
      align-items:center;
      padding:16px 16px 12px;
      background: linear-gradient(180deg, rgba(124,58,237,.08), rgba(47,111,237,.06));
      border-bottom:1px solid rgba(180,218,255,.70);
    }
    .qnum{
      width:30px;
      height:30px;
      border-radius:999px;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      flex:0 0 auto;
      box-shadow: 0 10px 18px rgba(47,111,237,.22);
    }
    .qtitle{
      margin:0;
      font-size:15px;
      font-weight:950;
      color:var(--text);
    }
    .qhint{
      margin:3px 0 0;
      font-size:13px;
      color:var(--muted);
      font-weight:650;
    }

    .qbody{
      padding:14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* option row clickable */
    .optionRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(180,218,255,.70);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease, background .15s ease;
      user-select:none;
    }
    .optionRow:hover{
      border-color: rgba(107,156,255,.80);
      box-shadow: 0 10px 18px rgba(47,111,237,.10);
      background: #ffffff;
    }
    .optionRow:active{transform:scale(.995)}

    .optionRow input{
      margin-top:2px;
      transform: scale(1.08);
      accent-color: var(--primary);
      cursor:pointer;
      flex:0 0 auto;
    }
    .optionRow label{
      width:100%;
      cursor:pointer;
      font-weight:850;
      color:#1b2b4a;
      line-height:1.25;
    }

    /* selected style */
    .optionRow.selected{
      border-color: rgba(47,111,237,.95);
      background: rgba(47,111,237,.06);
      box-shadow: 0 12px 22px rgba(47,111,237,.12);
    }

    /* nav buttons */
    .nav{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .btn{
      border:0;
      border-radius:16px;
      padding:12px 18px;
      font-size:15px;
      font-weight:950;
      cursor:pointer;
      transition: filter .15s ease, transform .05s ease, opacity .15s ease;
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      box-shadow: 0 14px 26px rgba(47,111,237,.20);
    }
    .btnPrimary:hover{filter:brightness(1.03)}
    .btnGhost{
      background: rgba(47,111,237,.10);
      color: var(--primary2);
      border:1px solid rgba(180,218,255,.65);
    }
    .btnGhost:hover{filter:brightness(1.03)}
    .btnDanger{
      background: rgba(220,38,38,.10);
      color:#991b1b;
      border:1px solid rgba(220,38,38,.20);
    }
    .btnDanger:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none;}

    /* results */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .rec{
      border:1px solid rgba(180,218,255,.70);
      border-radius:18px;
      padding:16px;
      background: rgba(255,255,255,.88);
      box-shadow: 0 12px 22px rgba(15, 60, 110, 0.08);
    }
    .rec h3{
      margin:0 0 10px;
      font-size:15px;
      color: var(--primary2);
      letter-spacing:-.2px;
    }
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
    .chip{
      background: rgba(237,246,255,.92);
      border:1px solid rgba(180,218,255,.70);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .motivo{margin:0;color:#22304a;line-height:1.45;font-size:14px}
    .score{margin-top:10px;font-weight:950;color:var(--primary2)}

    .jobs{
      margin:10px 0 0;
      padding-left:18px;
      color:#22304a;
      font-size:14px;
      line-height:1.45;
      font-weight:700;
    }

    pre{
      background:#061a2b;
      color:#d7f2ff;
      padding:18px;
      border-radius:18px;
      overflow:auto;
      max-height:420px;
      font-size:13px;
      border:1px solid rgba(207,228,255,.25);
    }

    .hide{display:none}

    .overlay.hide{ display:none !important; }

    /* =========================
       Overlay de carga (UX)
       ========================= */
    .overlay{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(6, 26, 43, .42);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }

    .overlayCard{
      width: min(560px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(180, 218, 255, .55);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      box-shadow: 0 22px 70px rgba(0,0,0,.22);
      padding: 16px;
      display:flex;
      gap: 14px;
      align-items:flex-start;
    }

    .spinner{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 4px solid rgba(47,111,237,.18);
      border-top-color: rgba(47,111,237,.95);
      animation: spin .8s linear infinite;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    @keyframes spin{
      to { transform: rotate(360deg); }
    }

    .overlayTitle{
      font-weight: 950;
      color: var(--primary2);
      font-size: 16px;
      letter-spacing: -.2px;
    }

    .overlayMsg{
      margin-top: 4px;
      color: #1b2b4a;
      font-weight: 850;
      font-size: 14px;
      line-height: 1.35;
    }

    .overlayHint{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <a class="backlink" href="index.html">‚Üê Volver a bienvenida</a>
    <div class="small" id="catCount">Categor√≠a 1 de 5</div>
  </div>

  <div class="progressWrap">
    <div class="progressLine"><div class="progressFill" id="progressFill"></div></div>
    <div class="progressMeta">
      <span id="progressLeft">Categor√≠a 1 de 5</span>
      <span id="progressRight">20% completado</span>
    </div>
  </div>

  <div class="card" id="wizardCard">
    <div class="hero">
      <div class="icon" id="catIcon">‚ô•</div>
      <div>
        <h1 id="catName">√Åreas de Inter√©s</h1>
        <p class="desc" id="catDesc">Identifica las √°reas que m√°s te apasionan y despiertan tu curiosidad</p>
      </div>
    </div>

    <div id="questionsHost"></div>

    <div class="nav">
      <button class="btn btnGhost" id="btnPrev">Anterior</button>
      <button class="btn btnPrimary" id="btnNext">Siguiente</button>
    </div>
  </div>

  <div class="card hide" id="resultCard">
    <div class="hero">
      <div class="icon">‚úì</div>
      <div>
        <h1>Resultado final</h1>
        <p class="desc">Estas son las <b>3 mejores recomendaciones</b> de ciclos de FP en la Comunidad Valenciana.</p>
      </div>
    </div>

    <div style="height:14px"></div>

    <div id="notaSalarios" class="chip" style="display:inline-block;margin-bottom:12px;"></div>

    <div class="grid" id="cards">
      <div class="rec">Rellena el cuestionario y env√≠a a la IA üôÇ</div>
    </div>

    <div class="nav" style="justify-content:flex-end">
      <button class="btn btnDanger" id="btnAgain">Reiniciar</button>
    </div>
  </div>

  <div class="card hide" id="jsonCard">
    <h1 style="font-size:20px;margin:0 0 10px;color:var(--primary2)">JSON devuelto por la IA</h1>
    <pre id="output">{ }</pre>
  </div>

</div>

<!-- OVERLAY CARGANDO -->
<div id="loadingOverlay" class="overlay hide" aria-live="polite" aria-busy="true">
  <div class="overlayCard">
    <div class="spinner" aria-hidden="true"></div>
    <div class="overlayText">
      <div class="overlayTitle">Procesando tus respuestas‚Ä¶</div>
      <div class="overlayMsg" id="loadingMsg">Analizando tu perfil.</div>
      <div class="overlayHint">Esto puede tardar unos segundos. No cierres la p√°gina.</div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  Preguntas (las tuyas)
 *  ========================= */
const questionnaireData = [
  {
    id: "interests",
    name: "√Åreas de Inter√©s",
    description: "Identifica las √°reas que m√°s te apasionan y despiertan tu curiosidad",
    icon: "heart",
    questions: [
      { id: "q1", text: "¬øQu√© √°reas acad√©micas te resultan m√°s interesantes?", options: [
        "Ciencias (Biolog√≠a, Qu√≠mica, F√≠sica)",
        "Tecnolog√≠a e Inform√°tica",
        "Matem√°ticas y L√≥gica",
        "Lenguas y Literatura",
        "Ciencias Sociales (Historia, Geograf√≠a)",
        "Arte y Dise√±o",
        "M√∫sica y Artes Esc√©nicas",
        "Educaci√≥n F√≠sica y Deportes",
        "Econom√≠a y Empresa"
      ]},
      { id: "q2", text: "¬øQu√© actividades disfrutas hacer en tu tiempo libre?", options: [
        "Resolver puzzles o juegos de l√≥gica",
        "Programar o usar tecnolog√≠a",
        "Leer o escribir",
        "Dibujar, dise√±ar o crear contenido",
        "Hacer deporte o actividad f√≠sica",
        "Ayudar a otros o hacer voluntariado",
        "Aprender cosas nuevas por mi cuenta",
        "Organizar actividades o liderar grupos",
        "Vender, negociar o emprender"
      ]},
      { id: "q3", text: "¬øEn qu√© entornos te sientes m√°s c√≥modo trabajando?", options: [
        "En un laboratorio o entorno cient√≠fico",
        "En una oficina con ordenadores y tecnolog√≠a",
        "En un taller o con tareas manuales",
        "En un entorno creativo (arte/dise√±o)",
        "En contacto con personas (atenci√≥n, salud, educaci√≥n)",
        "Al aire libre o con actividad f√≠sica",
        "En un entorno de negocio/empresa",
        "Indistinto, me adapto"
      ]}
    ]
  },
  {
    id: "skills",
    name: "Habilidades y Competencias",
    description: "Descubre tus puntos fuertes y qu√© habilidades quieres potenciar",
    icon: "sparkles",
    questions: [
      { id: "q4", text: "¬øEn qu√© √°reas consideras que tienes m√°s habilidad?", options: [
        "Resolver problemas complejos",
        "Creatividad e innovaci√≥n",
        "Comunicaci√≥n y expresi√≥n",
        "Trabajo en equipo",
        "Organizaci√≥n y planificaci√≥n",
        "Uso de tecnolog√≠a",
        "Habilidad manual o t√©cnica",
        "Negociaci√≥n o ventas",
        "Aprender r√°pido"
      ]},
      { id: "q5", text: "¬øQu√© competencias digitales dominas o te gustar√≠a desarrollar?", options: [
        "Programaci√≥n y desarrollo web",
        "Dise√±o gr√°fico o multimedia",
        "Ciberseguridad",
        "An√°lisis de datos",
        "Ofim√°tica (Word/Excel/Presentaciones)",
        "Redes y sistemas",
        "Marketing digital",
        "Edici√≥n de v√≠deo/foto"
      ]},
      { id: "q6", text: "¬øC√≥mo te describes en situaciones de aprendizaje?", options: [
        "Aprendo mejor haciendo (pr√°ctico)",
        "Me gusta entender la teor√≠a a fondo",
        "Soy constante y disciplinado",
        "Me cuesta mantener la atenci√≥n",
        "Me motiva aprender cosas nuevas",
        "Necesito objetivos claros",
        "Aprendo mejor con ejemplos reales"
      ]}
    ]
  },
  {
    id: "values",
    name: "Valores Profesionales",
    description: "Define qu√© es importante para ti en tu futuro trabajo",
    icon: "briefcase",
    questions: [
      { id: "q7", text: "¬øQu√© aspectos valoras m√°s en un trabajo?", options: [
        "Buen salario",
        "Estabilidad laboral",
        "Creatividad",
        "Ayudar a personas",
        "Trabajo din√°mico (no rutina)",
        "Crecimiento profesional",
        "Flexibilidad horaria",
        "Buen ambiente de trabajo",
        "Impacto social"
      ]},
      { id: "q8", text: "¬øQu√© tipo de contribuci√≥n te gustar√≠a hacer a la sociedad?", options: [
        "Mejorar la salud y el bienestar",
        "Impulsar la tecnolog√≠a y la innovaci√≥n",
        "Proteger el medio ambiente",
        "Educar y formar a otras personas",
        "Crear cultura y entretenimiento",
        "Mejorar la econom√≠a y el empleo",
        "Asegurar la seguridad (f√≠sica o digital)",
        "No lo tengo claro todav√≠a"
      ]}
    ]
  },
  {
    id: "learning",
    name: "Preferencias de Aprendizaje",
    description: "Elige c√≥mo te gustar√≠a estudiar y formarte",
    icon: "graduation",
    questions: [
      { id: "q9", text: "¬øQu√© tipo de formaci√≥n te atrae m√°s?", options: [
        "Formaci√≥n muy pr√°ctica (taller/laboratorio)",
        "Combinaci√≥n teor√≠a + pr√°ctica",
        "Proyectos reales",
        "Aprender con empresas (dual / pr√°cticas)",
        "Aprender de forma m√°s te√≥rica",
        "Cursos cortos y especializados",
        "Estudios m√°s largos"
      ]},
      { id: "q10", text: "¬øQu√© metodolog√≠as de ense√±anza prefieres?", options: [
        "Clases con ejercicios y casos reales",
        "Proyectos en grupo",
        "Aprendizaje por retos",
        "Trabajo individual",
        "V√≠deos y recursos digitales",
        "Explicaciones paso a paso",
        "Evaluaci√≥n continua (peque√±as entregas)"
      ]}
    ]
  },
  {
    id: "expectations",
    name: "Expectativas Futuras",
    description: "Define hacia d√≥nde quieres orientar tu futuro profesional",
    icon: "target",
    questions: [
      { id: "q11", text: "¬øC√≥mo te ves trabajando en el futuro?", options: [
        "En una empresa tecnol√≥gica",
        "En sanidad o servicios sociales",
        "En un entorno creativo (dise√±o, audiovisual)",
        "En educaci√≥n o formaci√≥n",
        "En industria o mantenimiento",
        "En deporte o actividades f√≠sicas",
        "En empresa/administraci√≥n/negocio"
      ]},
      { id: "q12", text: "¬øQu√© nivel de reto y presi√≥n te resulta estimulante?", options: [
        "Bajo: prefiero calma y estabilidad",
        "Moderado: retos asumibles",
        "Alto: me motivan desaf√≠os constantes",
        "Depende del √°rea, puedo adaptarme",
        "No lo tengo claro",
        "Prefiero ir probando"
      ]},
      { id: "q13", text: "¬øEn qu√© sectores te gustar√≠a trabajar?", options: [
        "Inform√°tica / tecnolog√≠a",
        "Sanidad",
        "Educaci√≥n",
        "Deporte",
        "Administraci√≥n y empresa",
        "Dise√±o / audiovisual",
        "Industria",
        "Comercio",
        "Log√≠stica",
        "Medio ambiente",
        "Turismo"
      ]}
    ]
  }
];

/** =========================
 *  Estado + helpers
 *  ========================= */
let step = 0;
const totalSteps = questionnaireData.length;
const answers = {}; // { qId: [options...] }

const elCatCount = document.getElementById("catCount");
const elProgFill = document.getElementById("progressFill");
const elProgLeft = document.getElementById("progressLeft");
const elProgRight = document.getElementById("progressRight");
const elCatIcon = document.getElementById("catIcon");
const elCatName = document.getElementById("catName");
const elCatDesc = document.getElementById("catDesc");
const elQuestionsHost = document.getElementById("questionsHost");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");

const wizardCard = document.getElementById("wizardCard");
const resultCard = document.getElementById("resultCard");
const jsonCard = document.getElementById("jsonCard");
const cards = document.getElementById("cards");
const output = document.getElementById("output");
const notaSalarios = document.getElementById("notaSalarios");

/** =========================
 *  UX: overlay "procesando"
 *  ========================= */
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingMsg = document.getElementById("loadingMsg");
let loadingTimer = null;
let loadingRotate = null;

function setBusy(isBusy){
  btnPrev.disabled = isBusy || (step === 0);
  btnNext.disabled = isBusy;
  wizardCard.style.pointerEvents = isBusy ? "none" : "auto";
  wizardCard.style.opacity = isBusy ? "0.92" : "1";
}

function showLoading(){
  const messages = [
    "Analizando tu perfil y tus preferencias‚Ä¶",
    "Relacionando tus intereses con familias profesionales‚Ä¶",
    "Buscando ciclos que encajen contigo‚Ä¶",
    "Preparando las 3 mejores recomendaciones‚Ä¶"
  ];
  let i = 0;
  loadingMsg.textContent = messages[i];

  loadingOverlay.classList.remove("hide");
  setBusy(true);

  loadingRotate = setInterval(() => {
    i = (i + 1) % messages.length;
    loadingMsg.textContent = messages[i];
  }, 2000);

  loadingTimer = setTimeout(() => {
    loadingMsg.textContent = "Esto est√° tardando un poco m√°s de lo normal‚Ä¶ seguimos trabajando üôÇ";
  }, 12000);
}

function hideLoading(){
  loadingOverlay.classList.add("hide");
  setBusy(false);

  if (loadingRotate) { clearInterval(loadingRotate); loadingRotate = null; }
  if (loadingTimer) { clearTimeout(loadingTimer); loadingTimer = null; }
}

function iconChar(icon){
  switch(icon){
    case "heart": return "‚ô•";
    case "sparkles": return "‚ú¶";
    case "briefcase": return "üíº";
    case "graduation": return "üéì";
    case "target": return "üéØ";
    default: return "‚òÖ";
  }
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setProgress(){
  const pct = Math.round(((step+1)/totalSteps)*100);
  elCatCount.textContent = `Categor√≠a ${step+1} de ${totalSteps}`;
  elProgLeft.textContent = `Categor√≠a ${step+1} de ${totalSteps}`;
  elProgRight.textContent = `${pct}% completado`;
  elProgFill.style.width = `${pct}%`;
}

function renderStep(){
  const cat = questionnaireData[step];

  setProgress();

  elCatIcon.textContent = iconChar(cat.icon);
  elCatName.textContent = cat.name;
  elCatDesc.textContent = cat.description;

  btnPrev.disabled = (step === 0);
  btnNext.textContent = (step === totalSteps-1) ? "Enviar a la IA" : "Siguiente";

  elQuestionsHost.innerHTML = cat.questions.map((q, idx) => {
    const qSaved = answers[q.id] || [];
    const optionsHtml = q.options.map((opt, i) => {
      const id = `${q.id}_${i}`;
      const checked = qSaved.includes(opt) ? "checked" : "";
      const selectedClass = qSaved.includes(opt) ? "selected" : "";
      return `
        <div class="optionRow ${selectedClass}" data-for="${id}">
          <input type="checkbox" id="${id}" data-qid="${q.id}" value="${escapeHtml(opt)}" ${checked}>
          <label for="${id}">${escapeHtml(opt)}</label>
        </div>
      `;
    }).join("");

    return `
      <div class="qblock">
        <div class="qhead">
          <div class="qnum">${idx+1}</div>
          <div>
            <p class="qtitle">${escapeHtml(q.text)}</p>
            <p class="qhint">Selecciona todas las opciones que te identifiquen</p>
          </div>
        </div>
        <div class="qbody">
          ${optionsHtml}
        </div>
      </div>
    `;
  }).join("");

  // Click en toda la fila para alternar (sin doble toggle)
  elQuestionsHost.querySelectorAll('.optionRow[data-for]').forEach(row => {
    row.addEventListener("click", (ev) => {
      const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
      if (tag === "input" || tag === "label") return;

      const id = row.getAttribute("data-for");
      const cb = document.getElementById(id);
      if (!cb) return;
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event("change", { bubbles: true }));
    });
  });

  elQuestionsHost.querySelectorAll('input[type="checkbox"][data-qid]').forEach(cb => {
    cb.addEventListener("change", (e) => {
      const qid = e.target.getAttribute("data-qid");
      const val = e.target.value;
      const arr = answers[qid] ? [...answers[qid]] : [];

      if (e.target.checked) {
        if (!arr.includes(val)) arr.push(val);
      } else {
        const idx = arr.indexOf(val);
        if (idx >= 0) arr.splice(idx, 1);
      }
      answers[qid] = arr;

      const row = e.target.closest(".optionRow");
      if (row){
        if (e.target.checked) row.classList.add("selected");
        else row.classList.remove("selected");
      }
    });
  });
}

function validateStep(){
  const cat = questionnaireData[step];
  for (const q of cat.questions){
    const arr = answers[q.id] || [];
    if (!arr.length){
      alert(`Te falta responder:\n- ${q.text}`);
      return false;
    }
  }
  return true;
}

/** =========================
 *  Env√≠o a backend (Nova Pro)
 *  ========================= */
async function sendToAI(){
  output.textContent = "Consultando a la IA (Nova Pro)...";
  cards.innerHTML = `<div class="rec">Consultando a la IA‚Ä¶</div>`;
  notaSalarios.textContent = "";

  showLoading();

  const payload = { version: "1.0", answers: answers };

  try{
    const res = await fetch("http://127.0.0.1:8000/api/orientacion",{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    output.textContent = JSON.stringify(json, null, 2);

    if (json.ok && json.data && Array.isArray(json.data.recomendaciones)){
      renderTop3(json.data.recomendaciones, json.data.nota_salarios);
    } else {
      cards.innerHTML = `<div class="rec">No se recibieron recomendaciones.</div>`;
    }

    wizardCard.classList.add("hide");
    resultCard.classList.remove("hide");
    jsonCard.classList.remove("hide");
    window.scrollTo({top:0, behavior:"smooth"});
  }catch(err){
    output.textContent = "Error al conectar con el backend: " + err;
    cards.innerHTML = `<div class="rec">Error de conexi√≥n.</div>`;
    wizardCard.classList.add("hide");
    resultCard.classList.remove("hide");
    jsonCard.classList.remove("hide");
    window.scrollTo({top:0, behavior:"smooth"});
  }finally{
    hideLoading();
  }
}

function renderTop3(recs, nota){
  notaSalarios.textContent = (nota && String(nota).trim())
    ? nota
    : "Rangos salariales orientativos (pueden variar por provincia, experiencia y empresa).";

  cards.innerHTML = recs.slice(0,3).map((r, idx) => {
    const ciclo = escapeHtml(r.ciclo);
    const grado = escapeHtml(r.grado);
    const familia = escapeHtml(r.familia_profesional);
    const motivo = escapeHtml(r.motivo);
    const salario = escapeHtml(r.rango_salarial || "‚Äî");
    const encaje = Number.isFinite(r.encaje) ? r.encaje : parseInt(r.encaje || "0", 10) || 0;
    const salidas = Array.isArray(r.salidas_laborales) ? r.salidas_laborales : [];

    const salidasHtml = salidas.length
      ? `<ul class="jobs">${salidas.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>`
      : `<div class="chip" style="display:inline-block;margin-top:10px;">Salidas laborales: ‚Äî</div>`;

    return `
      <div class="rec">
        <h3>${idx+1}. ${ciclo}</h3>
        <div class="meta">
          <span class="chip">${grado}</span>
          <span class="chip">${familia}</span>
          <span class="chip">Salario: ${salario}</span>
        </div>
        <p class="motivo">${motivo}</p>
        <div class="score">Encaje: ${encaje}/100</div>
        ${salidasHtml}
      </div>
    `;
  }).join("");
}

/** =========================
 *  Eventos
 *  ========================= */
btnPrev.addEventListener("click", () => {
  if (step > 0){
    step--;
    renderStep();
    window.scrollTo({top:0, behavior:"smooth"});
  }
});

btnNext.addEventListener("click", async () => {
  if (!validateStep()) return;

  if (step < totalSteps-1){
    step++;
    renderStep();
    window.scrollTo({top:0, behavior:"smooth"});
  } else {
    await sendToAI();
  }
});

document.getElementById("btnAgain").addEventListener("click", () => {
  for (const k of Object.keys(answers)) delete answers[k];
  step = 0;
  resultCard.classList.add("hide");
  jsonCard.classList.add("hide");
  wizardCard.classList.remove("hide");
  renderStep();
  window.scrollTo({top:0, behavior:"smooth"});
});

// Init
renderStep();
</script>

</body>
</html>
