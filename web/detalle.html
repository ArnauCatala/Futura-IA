<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa y radio ‚Äì Orientaci√≥n FP (CV)</title>

  <!-- Leaflet (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- html2canvas (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --card:#ffffff;
      --primary:#2f6fed;
      --primary-dark:#1e55c9;
      --accent:#7c3aed;
      --line:#dbe7ff;
      --text:#0b1a33;
      --muted:#4b5a77;
      --radius:16px;
      --shadow:0 10px 26px rgba(30,70,160,.12);
      --soft:#f6f9ff;
      --chip:#eff5ff;
      --warnbg: rgba(245,158,11,.12);
      --warn: #92400e;
      --errbg: rgba(220,38,38,.10);
      --err: #991b1b;
      --okbg: rgba(16,185,129,.10);
      --ok: #065f46;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:linear-gradient(180deg,#f4f8ff,#eaf1ff);
      color:var(--text);
    }
    .wrap{max-width:1050px;margin:auto;padding:28px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin-bottom:18px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;
    }
    .backlink{
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);text-decoration:none;font-weight:900;
      padding:8px 10px;border-radius:12px;
    }
    .backlink:hover{background:rgba(47,111,237,.08)}
    h1{margin:0 0 6px;font-size:24px;color:var(--primary-dark)}
    .desc{margin:0;color:var(--muted);font-weight:650;line-height:1.35}

    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      background:var(--chip);
      border:1px solid var(--line);
      padding:8px 12px;border-radius:999px;
      font-weight:900;color:var(--muted);font-size:13px;
    }

    .block{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:16px;
      padding:16px;
      margin-top:16px;
    }

    .row{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media(max-width:980px){.row{grid-template-columns:1fr}}

    label{display:block;font-weight:900;margin-bottom:6px;color:#1b2b4a}
    input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      color:#1b2b4a;
      outline:none;
    }

    .sliderWrap{
      margin-top:10px;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    .sliderTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .sliderVal{
      font-weight:950;
      color:var(--primary-dark);
      background:rgba(47,111,237,.10);
      border:1px solid rgba(47,111,237,.22);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    input[type="range"]{width:100%}

    .hint{margin:10px 0 0;color:var(--muted);font-weight:650;font-size:13px}

    .alert{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      font-weight:850;
      font-size:13px;
      display:none;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .alert.warn{display:block;background:var(--warnbg);color:var(--warn);border-color: rgba(245,158,11,.25);}
    .alert.err{display:block;background:var(--errbg);color:var(--err);border-color: rgba(220,38,38,.25);}
    .alert.ok{display:block;background:var(--okbg);color:var(--ok);border-color: rgba(16,185,129,.22);}

    .mapWrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    #map{
      width:100%;
      height:420px;
    }

    .nav{
      display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap;margin-top:18px;
    }
    .btn{
      border:0;border-radius:14px;
      padding:12px 18px;font-size:15px;font-weight:950;cursor:pointer;
    }
    .btnPrimary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;}
    .btnPrimary:hover{filter:brightness(.95)}
    .btnGhost{background:rgba(47,111,237,.10);color:var(--primary-dark);}
    .btnGhost:hover{background:rgba(47,111,237,.16)}

    /* Debug oculto (lo necesitamos, pero no se ve) */
    pre{ display:none; }

    .tiny{font-size:12px;color:var(--muted);font-weight:700;margin-top:8px;line-height:1.35;}

    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <a class="backlink" href="cuestionario.html">‚Üê Volver a empezar el cuestionario</a>
  </div>

  <div class="card">
    <h1>Mapa y radio (Comunitat Valenciana)</h1>
    <p class="desc">Selecciona d√≥nde vives y un radio en km. Ver√°s en el mapa las poblaciones del ciclo que cumplen el criterio.</p>

    <div class="chips">
      <div class="chip" id="chipCiclo">Ciclo: ‚Äî</div>
      <div class="chip" id="chipGrado">Grado: ‚Äî</div>
    </div>

    <div class="block">
      <div class="row">
        <div>
          <label for="origen">¬øD√≥nde vives (o vas a vivir)?</label>
          <input id="origen" type="text" list="listaMunicipios" placeholder="Escribe y elige un municipio de la CV‚Ä¶">
          <datalist id="listaMunicipios"></datalist>

          <div class="sliderWrap">
            <div class="sliderTop">
              <div style="font-weight:950;color:#1b2b4a">Radio m√°ximo</div>
              <div class="sliderVal" id="kmLabel">20 km</div>
            </div>
            <input id="km" type="range" min="1" max="50" value="20">
            <div class="tiny">El mapa dibuja el c√≠rculo y marca las poblaciones del ciclo dentro del radio.</div>
          </div>

          <div style="height:12px"></div>

          <label for="ciudad">Ciudades del ciclo dentro del radio</label>
          <select id="ciudad">
            <option value="">Cargando ciudades...</option>
          </select>
          <div class="hint" id="hintCiudades"></div>

          <div class="alert warn" id="warnBox"></div>
          <div class="alert err" id="errBox"></div>
          <div class="alert ok" id="okBox"></div>
        </div>

        <div>
          <label>Mapa (punto + radio + poblaciones)</label>
          <div class="mapWrap">
            <div id="map"></div>
          </div>
          <div class="tiny">
            üè† Tu municipio = marcador azul. <br>
            üìç Poblaciones del ciclo dentro del radio = marcadores ‚Äúcon dibujito‚Äù.
          </div>
        </div>
      </div>

      <div class="nav">
        <button class="btn btnGhost" id="btnVolver" type="button">Volver</button>
        <button class="btn btnPrimary" id="btnGuardar" type="button">Guardar (PDF)</button>
      </div>

      <!-- Debug oculto -->
      <pre id="debug">{ }</pre>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="
  position:fixed;
  inset:0;
  background:rgba(244,248,255,.85);
  backdrop-filter: blur(2px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    border-radius:18px;
    padding:26px 30px;
    box-shadow:0 20px 50px rgba(30,70,160,.18);
    text-align:center;
    max-width:360px;
  ">
    <div style="
      width:46px;height:46px;
      border-radius:50%;
      border:4px solid #dbe7ff;
      border-top-color:#2f6fed;
      margin:0 auto 14px;
      animation:spin 1s linear infinite;
    "></div>

    <div style="font-weight:900;color:#1e55c9;font-size:15px">
      Buscando ciudades
    </div>
    <div style="margin-top:6px;color:#4b5a77;font-weight:700;font-size:13px" id="loadingMsg">
      Analizando criterios y distancia‚Ä¶
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
function qs(name){
  const u = new URL(window.location.href);
  return u.searchParams.get(name) || "";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function showWarn(msg){
  const el = document.getElementById("warnBox");
  el.textContent = msg || "";
  el.className = msg ? "alert warn" : "alert";
}
function showErr(msg){
  const el = document.getElementById("errBox");
  el.textContent = msg || "";
  el.className = msg ? "alert err" : "alert";
}
function showOk(msg){
  const el = document.getElementById("okBox");
  el.textContent = msg || "";
  el.className = msg ? "alert ok" : "alert";
}
function haversineKm(a, b){
  const R = 6371;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lon - a.lon);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);

  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* =========================
   Loading overlay (bloquea todo)
========================= */
function setLoading(state, msg){
  const overlay = document.getElementById("loadingOverlay");
  const msgEl = document.getElementById("loadingMsg");
  if(msgEl && msg) msgEl.textContent = msg;

  overlay.style.display = state ? "flex" : "none";

  document.querySelectorAll("input, select, button").forEach(el => {
    el.disabled = state;
  });

  if(state){
    map.dragging.disable();
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    if(map.tap) map.tap.disable();
    document.getElementById("map").style.pointerEvents = "none";
  }else{
    map.dragging.enable();
    map.scrollWheelZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    if(map.tap) map.tap.enable();
    document.getElementById("map").style.pointerEvents = "auto";

    // üî• FIX Leaflet t√≠pico: al volver del overlay, recalcula el tama√±o
    setTimeout(() => map.invalidateSize(), 50);
  }
}

/* =========================
   Estado
========================= */
const ciclo = qs("ciclo");
const grado = qs("grado");

document.getElementById("chipCiclo").innerHTML = "Ciclo: <b>" + escapeHtml(ciclo || "‚Äî") + "</b>";
document.getElementById("chipGrado").innerHTML = "Grado: <b>" + escapeHtml(grado || "‚Äî") + "</b>";

const origenInput = document.getElementById("origen");
const kmInput = document.getElementById("km");
const kmLabel = document.getElementById("kmLabel");
const selCiudad = document.getElementById("ciudad");
const hint = document.getElementById("hintCiudades");
const debug = document.getElementById("debug");

kmLabel.textContent = kmInput.value + " km";

let municipiosCV = [];
let allCycleCities = [];
let filteredCycleCities = [];
let _typeTimer = null;

/* =========================
   Leaflet map
========================= */
const map = L.map("map", { zoomControl: true });
map.setView([39.47, -0.38], 8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let originMarker = null;
let radiusCircle = null;
let townsLayer = L.layerGroup().addTo(map);

// ‚úÖ Nuevo: para poder saltar al marcador por nombre
let townMarkersByCity = new Map();

const townIcon = L.divIcon({
  className: "",
  html: `
    <div style="
      width:28px;height:28px;border-radius:999px;
      background:rgba(124,58,237,.14);
      border:2px solid rgba(124,58,237,.55);
      display:flex;align-items:center;justify-content:center;
      font-size:16px; font-weight:900;
      box-shadow:0 6px 18px rgba(30,70,160,.18);
    ">üìç</div>
  `,
  iconSize: [28, 28],
  iconAnchor: [14, 14]
});

const originIcon = L.divIcon({
  className: "",
  html: `
    <div style="
      width:30px;height:30px;border-radius:999px;
      background:rgba(47,111,237,.16);
      border:2px solid rgba(47,111,237,.70);
      display:flex;align-items:center;justify-content:center;
      font-size:16px; font-weight:900;
      box-shadow:0 6px 18px rgba(30,70,160,.18);
    ">üè†</div>
  `,
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

/* =========================
   Geocoding + cache
========================= */
function cacheKey(place){ return "geo_cv_" + place.toLowerCase().trim(); }
function getCachedGeo(place){
  try{
    const raw = localStorage.getItem(cacheKey(place));
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(obj && typeof obj.lat === "number" && typeof obj.lon === "number") return obj;
  }catch(_){}
  return null;
}
function setCachedGeo(place, geo){
  try{ localStorage.setItem(cacheKey(place), JSON.stringify(geo)); }catch(_){}
}
async function geocodeMunicipioCV(place){
  const p = (place || "").trim();
  if(!p) return null;

  const cached = getCachedGeo(p);
  if(cached) return cached;

  const q = encodeURIComponent(`${p}, Comunitat Valenciana, Espa√±a`);
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;

  await sleep(250);

  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  if(!res.ok) return null;

  const arr = await res.json();
  if(!Array.isArray(arr) || !arr.length) return null;

  const lat = parseFloat(arr[0].lat);
  const lon = parseFloat(arr[0].lon);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

  const geo = { lat, lon };
  setCachedGeo(p, geo);
  return geo;
}

/* =========================
   Backend data
========================= */
async function loadMunicipiosCV(){
  showWarn(""); showErr(""); showOk("");
  const dl = document.getElementById("listaMunicipios");
  dl.innerHTML = "";

  try{
    const res = await fetch("http://127.0.0.1:8000/api/municipios");
    const json = await res.json();

    if(!json.ok || !Array.isArray(json.municipios)){
      showWarn("No se pudieron cargar los municipios completos. Revisa /api/municipios.");
      return;
    }

    municipiosCV = json.municipios.slice();
    municipiosCV.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      dl.appendChild(opt);
    });

    showOk(`Municipios cargados: ${municipiosCV.length}`);
  }catch(err){
    showWarn("No se pudieron cargar municipios (backend no disponible).");
  }
}

async function loadCycleCities(){
  selCiudad.innerHTML = `<option value="">Cargando ciudades...</option>`;
  hint.textContent = "";
  showWarn(""); showErr("");

  try{
    const url = `http://127.0.0.1:8000/api/ciudades?ciclo=${encodeURIComponent(ciclo)}&grado=${encodeURIComponent(grado)}`;
    const res = await fetch(url);
    const json = await res.json();

    if(!json.ok){
      selCiudad.innerHTML = `<option value="">No se pudieron cargar ciudades</option>`;
      showErr(json.error || "Error desconocido en backend.");
      return;
    }

    if(json.match && json.match.matched_ciclo){
      const rf = (json.match.rapidfuzz ? "RapidFuzz" : "Difflib");
      const ginfo = json.match.matched_grado ? ` ¬∑ grado CSV: ${json.match.matched_grado} (${json.match.grado_score}/100)` : "";
      hint.textContent = `Ciclo detectado en CSV: ${json.match.matched_ciclo} (${json.match.match_score}/100) ¬∑ ${rf}${ginfo}`;
    }

    if(json.warning) showWarn(json.warning);
    if(json.source) showWarn((document.getElementById("warnBox").textContent ? document.getElementById("warnBox").textContent + "\n" : "") + `Fuente: ${json.source}`);

    allCycleCities = Array.isArray(json.ciudades) ? json.ciudades : [];

    if(!allCycleCities.length){
      selCiudad.innerHTML = `<option value="">No hay ciudades para este ciclo</option>`;
      showWarn((document.getElementById("warnBox").textContent ? document.getElementById("warnBox").textContent + "\n" : "") + "No hay ciudades asociadas en el CSV para ese nombre.");
      return;
    }

    paintCitySelect(allCycleCities, "Selecciona una ciudad...");
    showOk((document.getElementById("okBox").textContent ? document.getElementById("okBox").textContent + "\n" : "") + `Ciudades del ciclo: ${allCycleCities.length}`);

  }catch(err){
    selCiudad.innerHTML = `<option value="">Error cargando ciudades</option>`;
    showErr(String(err));
  }
}

function paintCitySelect(cityList, firstLabel){
  const list = cityList || [];
  selCiudad.innerHTML =
    `<option value="">${escapeHtml(firstLabel || "Selecciona una ciudad...")}</option>` +
    list.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
}

/* =========================
   Map drawing
========================= */
function clearTownMarkers(){
  townsLayer.clearLayers();
  townMarkersByCity = new Map();
}

function drawOriginAndRadius(geoOrigin){
  const km = parseInt(kmInput.value, 10) || 20;
  const meters = km * 1000;

  if(originMarker) map.removeLayer(originMarker);
  originMarker = L.marker([geoOrigin.lat, geoOrigin.lon], { icon: originIcon }).addTo(map);
  originMarker.bindPopup(`<b>Tu municipio</b><br>${escapeHtml(origenInput.value.trim())}`);

  if(radiusCircle) map.removeLayer(radiusCircle);
  radiusCircle = L.circle([geoOrigin.lat, geoOrigin.lon], {
    radius: meters,
    color: "#2f6fed",
    weight: 2,
    fillColor: "#2f6fed",
    fillOpacity: 0.12
  }).addTo(map);

  map.fitBounds(radiusCircle.getBounds(), { padding: [18,18] });
}

function drawTownMarkers(){
  clearTownMarkers();

  filteredCycleCities.forEach((t) => {
    const marker = L.marker([t.geo.lat, t.geo.lon], { icon: townIcon }).addTo(townsLayer);
    townMarkersByCity.set(t.city, marker);

    const kmText = (Math.round(t.km * 10) / 10) + " km";
    marker.bindPopup(`<b>${escapeHtml(t.city)}</b><br><span style="font-weight:800;color:#4b5a77">Dentro del radio ¬∑ ${kmText}</span>`);
  });
}

/* =========================
   Filtering
========================= */
function isValidMunicipioCV(name){
  const v = (name || "").trim().toLowerCase();
  if(!v) return false;
  return municipiosCV.some(m => m.toLowerCase() === v);
}

async function applyDistanceFilter(){
  showErr("");
  const origen = origenInput.value.trim();
  const km = parseInt(kmInput.value, 10) || 20;
  kmLabel.textContent = km + " km";

  if(!origen){
    paintCitySelect(allCycleCities, "Selecciona una ciudad...");
    clearTownMarkers();
    if(originMarker) { map.removeLayer(originMarker); originMarker = null; }
    if(radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
    showOk(`Ciudades del ciclo (sin filtrar): ${allCycleCities.length}`);
    return;
  }

  if(!isValidMunicipioCV(origen)){
    paintCitySelect(allCycleCities, "Selecciona una ciudad...");
    clearTownMarkers();
    showWarn("Elige un municipio de la lista (autocompletar) para poder calcular distancias.");
    return;
  }

  setLoading(true, "Buscando ciudades dentro de los criterios‚Ä¶");

  try{
    showOk("Buscando ciudades dentro de los criterios‚Ä¶");

    const geoOrigen = await geocodeMunicipioCV(origen);
    if(!geoOrigen){
      paintCitySelect(allCycleCities, "Selecciona una ciudad...");
      clearTownMarkers();
      showWarn("No he podido localizar ese municipio. Prueba a seleccionarlo exactamente desde la lista.");
      return;
    }

    drawOriginAndRadius(geoOrigen);

    const results = [];
    let processed = 0;

    for(const city of allCycleCities){
      const g = await geocodeMunicipioCV(city);
      processed++;
      if(processed % 4 === 0){
        setLoading(true, `Buscando ciudades‚Ä¶ (${processed}/${allCycleCities.length})`);
      }
      if(!g) continue;

      const d = haversineKm(geoOrigen, g);
      if(d <= km){
        results.push({ city, km: d, geo: g });
      }
    }

    filteredCycleCities = results.sort((a,b) => a.km - b.km);
    const onlyNames = filteredCycleCities.map(x => x.city);

    if(!onlyNames.length){
      paintCitySelect([], "No hay ciudades dentro del radio");
      clearTownMarkers();
      showWarn(`No hay ciudades del ciclo a ‚â§ ${km} km desde "${origen}". Sube el radio o cambia el origen.`);
      return;
    }

    paintCitySelect(onlyNames, `Selecciona una ciudad (‚â§ ${km} km)`);
    drawTownMarkers();
    showOk(`Encontradas ${onlyNames.length} ciudades dentro del radio.`);

  }
  finally{
    setLoading(false);
  }
}

/* =========================
   PDF (con mapa sin deformar)
========================= */
function safeFilename(s){
  return (s || "documento")
    .toLowerCase()
    .replaceAll("√°","a").replaceAll("√©","e").replaceAll("√≠","i").replaceAll("√≥","o").replaceAll("√∫","u").replaceAll("√±","n")
    .replaceAll(/[^a-z0-9]+/g,"-")
    .replaceAll(/^-+|-+$/g,"")
    .slice(0,80);
}

function collect(){
  const chosen = selCiudad.value;
  const item = filteredCycleCities.find(x => x.city === chosen);

  return {
    ciclo,
    grado,
    origen: origenInput.value.trim(),
    radio_km: parseInt(kmInput.value, 10) || 20,
    ciudad_estudio: chosen,
    distancia_km_estimada: item ? Math.round(item.km * 10) / 10 : null,
    ciudades_en_radio: filteredCycleCities.map(x => ({
      ciudad: x.city,
      distancia_km: Math.round(x.km * 10) / 10
    }))
  };
}

function waitLeafletIdle(timeoutMs = 2500){
  return new Promise((resolve) => {
    let done = false;

    const finish = () => {
      if (done) return;
      done = true;
      map.off("idle", onIdle);
      resolve();
    };

    const onIdle = () => finish();

    map.on("idle", onIdle);

    setTimeout(finish, timeoutMs);
    map.invalidateSize();
  });
}

async function captureMapImage(){
  await waitLeafletIdle(2500);
  await sleep(150);

  const mapEl = document.getElementById("map");

  const canvas = await html2canvas(mapEl, {
    useCORS: true,
    allowTaint: true,
    backgroundColor: "#ffffff",
    scale: 2
  });

  return {
    dataUrl: canvas.toDataURL("image/png"),
    w: canvas.width,
    h: canvas.height
  };
}

async function generatePdf(){
  const data = collect();

  if(!data.origen){
    alert("Primero selecciona d√≥nde vives.");
    return;
  }
  if(!data.ciudades_en_radio || !data.ciudades_en_radio.length){
    alert("Todav√≠a no hay ciudades filtradas dentro del radio. Elige un origen y ajusta el radio.");
    return;
  }

  setLoading(true, "Generando PDF con el mapa‚Ä¶");

  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    const margin = 14;
    const pageW = 210;
    const pageH = 297;
    const usableW = pageW - margin*2;

    let y = 16;

    // T√≠tulo
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("Informe de b√∫squeda por distancia (FP CV)", margin, y);
    y += 8;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.setTextColor(60, 80, 120);

    const now = new Date();
    const fecha = now.toLocaleString("es-ES");

    const lines = [
      `Fecha: ${fecha}`,
      `Ciclo: ${data.ciclo || "-"}`,
      `Grado: ${data.grado || "-"}`,
      `Origen: ${data.origen || "-"}`,
      `Radio: ${data.radio_km} km`,
    ];
    doc.text(lines, margin, y);
    y += (lines.length * 5) + 4;

    // Lista de ciudades
    doc.setTextColor(11, 26, 51);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Poblaciones dentro del radio", margin, y);
    y += 6;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);

    const list = data.ciudades_en_radio.map((c, idx) => {
      const d = (typeof c.distancia_km === "number") ? ` (${c.distancia_km} km)` : "";
      return `${idx+1}. ${c.ciudad}${d}`;
    });

    const joined = list.join("\n");
    const wrapped = doc.splitTextToSize(joined, usableW);

    const lineH = 5;
    for(const line of wrapped){
      if(y > pageH - margin - 10){
        doc.addPage();
        y = 16;
      }
      doc.text(line, margin, y);
      y += lineH;
    }
    y += 4;

    // Mapa
    if(y > pageH - margin - 110){
      doc.addPage();
      y = 16;
    }

    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Mapa (captura)", margin, y);
    y += 6;

    const shot = await captureMapImage();

    const imgW = usableW;
    const imgH = imgW * (shot.h / shot.w);

    if(y + imgH > pageH - margin){
      doc.addPage();
      y = 16;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Mapa (captura)", margin, y);
      y += 6;
    }

    doc.addImage(shot.dataUrl, "PNG", margin, y, imgW, imgH);
    y += imgH + 6;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(90, 110, 150);
    doc.text("Nota: distancias calculadas en l√≠nea recta (haversine).", margin, y);

    const fname = `informe_${safeFilename(data.origen)}_${safeFilename(data.ciclo)}_${data.radio_km}km.pdf`;
    doc.save(fname);

    debug.textContent = JSON.stringify(data, null, 2);
  }
  catch(err){
    alert("Error generando PDF: " + err);
  }
  finally{
    setLoading(false);
  }
}

/* =========================
   Events
========================= */
document.getElementById("btnVolver").addEventListener("click", () => {
  window.location.href = "cuestionario.html";
});

document.getElementById("btnGuardar").addEventListener("click", async () => {
  await generatePdf();
});

kmInput.addEventListener("input", () => {
  kmLabel.textContent = kmInput.value + " km";
});

kmInput.addEventListener("change", async () => {
  await applyDistanceFilter();
});

origenInput.addEventListener("change", async () => {
  await applyDistanceFilter();
});

origenInput.addEventListener("input", () => {
  if(_typeTimer) clearTimeout(_typeTimer);
  _typeTimer = setTimeout(async () => {
    if(isValidMunicipioCV(origenInput.value.trim())){
      await applyDistanceFilter();
    }
  }, 250);
});

// ‚úÖ FIX principal: al seleccionar ciudad -> flyTo + popup
selCiudad.addEventListener("change", () => {
  const chosen = selCiudad.value;
  if(!chosen) return;

  const marker = townMarkersByCity.get(chosen);
  if(!marker) return;

  const ll = marker.getLatLng();

  // zoom ‚Äúbonito‚Äù: si est√°s muy lejos, te acerca; si ya est√°s cerca, no te rompe el zoom
  const targetZoom = Math.max(map.getZoom(), 11);

  map.flyTo(ll, targetZoom, { animate: true, duration: 0.8 });

  setTimeout(() => {
    marker.openPopup();
  }, 250);
});

/* =========================
   Init
========================= */
(async function init(){
  await loadMunicipiosCV();
  await loadCycleCities();
})();
</script>

</body>
</html>

